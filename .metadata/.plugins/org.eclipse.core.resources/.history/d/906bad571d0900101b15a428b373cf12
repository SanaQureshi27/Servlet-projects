package com.code.verse.servlets;

import javax.security.auth.message.callback.PrivateKeyCallback.Request;
import javax.servlet.*;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.*;
import com.code.verse.entity.User;
import com.code.verse.dao.UserDao;
import com.code.verse.helper.ConnectionProvider;
import com.code.verse.entity.Message;

import java.io.IOException;
import java.sql.SQLException;

@WebServlet("/login")
public class LoginServlet extends HttpServlet {

	private static final long serialVersionUID = 1L;

	@Override
	protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		// TODO Auto-generated method stub
		super.doGet(req, resp);
	}

	@Override
	protected void doPost(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {

		response.setContentType("text/html;charset=UTF-8");
		//
		String userEmail = request.getParameter("email");
		String userPassword = request.getParameter("password");
		try {
			UserDao dao = new UserDao(ConnectionProvider.getConnection());
			User u = dao.getUserByEmailAndPassword(userEmail, userPassword);
			if (u == null) {
				Message msg = new Message("Invalid details! try with another.", "error", "alert-danger");
				HttpSession s = request.getSession();
				s.setAttribute("msg", msg);
				response.sendRedirect("login_page.jsp");
			} else {
				HttpSession session = request.getSession();
				session.setAttribute("currentUser", u);
				response.sendRedirect("Profile.jsp");
			}
		} catch (SQLException e) {
			e.printStackTrace();
			response.sendRedirect("login_page.jsp?error=Database error, please try again.");
		}

	}

//    // Handle GET requests (prevents "GET not supported" error)
//    @Override
//    protected void doGet(HttpServletRequest request, HttpServletResponse response)
//            throws ServletException, IOException {
//        response.sendRedirect("login_page.jsp"); // Redirect users to the login page
//    }
//
//    // Handle POST requests
//    @Override
//    protected void doPost(HttpServletRequest request, HttpServletResponse response)
//            throws ServletException, IOException {
//        processRequest(request, response);
//    }
//
//    // Common logic for handling login
//    protected void processRequest(HttpServletRequest request, HttpServletResponse response)
//            throws ServletException, IOException {
//        
//        response.setContentType("text/html;charset=UTF-8");
//
//        String userEmail = request.getParameter("email");
//        String userPassword = request.getParameter("password");
//
//        try {
//            UserDao dao = new UserDao(ConnectionProvider.getConnection());
//            User u = dao.getUserByEmailAndPassword(userEmail, userPassword);
//
//            if (u == null) {
//            	
//            	Message msg = new Message("Invalid details! try with another.","error","alert-danger");
//            	HttpSession s= request.getSession();
//            	s.setAttribute("msg", msg);
//                response.sendRedirect("login_page.jsp");
//
//            } else {
//                HttpSession session = request.getSession();
//                session.setAttribute("currentUser", u);
//                response.sendRedirect("Profile.jsp");
//            }
//        } catch (SQLException e) {
//            e.printStackTrace();
//            response.sendRedirect("login_page.jsp?error=Database error, please try again.");
//        }
//    }
}
